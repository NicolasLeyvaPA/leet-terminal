# Environment Variables Template
# Copy this file to .env and fill in your values

# Database Configuration (REQUIRED)
USERS_DSN=postgres://leet_user:leet_password@localhost:5432/leet_users?sslmode=disable
TIMESCALE_DSN=postgres://leet_user:leet_password@localhost:5433/leet_terminal?sslmode=disable
RABBITMQ_URL=amqp://guest:guest@localhost:5672/

# Web Admin (for main app)
WEB_ADMIN_USERNAME=admin
WEB_ADMIN_PASSWORD=change_me_in_production
WEB_ADMIN_EMAIL=admin@example.com

# Ingestion API Keys (OPTIONAL - some sources work without keys)
KALSHI_API_KEY=
NEWS_API_KEY=

# Ingestion Configuration
POLYMARKET_API_URL=https://gamma-api.polymarket.com
INGESTION_INTERVAL=5m
NEWS_RETENTION_DAYS=30
MAX_RETRIES=3
RETRY_BACKOFF_SECONDS=5
REQUEST_TIMEOUT=30s

# For Testing
TEST_TIMESCALE_DSN=postgres://leet_user:leet_password@localhost:5433/leet_terminal_test?sslmode=disable
# Makefile for Leet Terminal Ingestion Pipeline

.PHONY: help build test test-unit test-integration run-dry run-markets run-news run clean deps

help: ## Show this help message
	@echo 'Usage: make [target]'
	@echo ''
	@echo 'Available targets:'
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-20s %s\n", $$1, $$2}'

deps: ## Install Go dependencies
	go mod download
	go mod tidy

build: ## Build the ingestion service
	go build -o bin/ingestion cmd/ingestion/main.go
	@echo "Built: bin/ingestion"

test-unit: ## Run unit tests
	cd services/ingestion && go test -v

test-integration: ## Run integration tests (requires database)
	INTEGRATION_TEST=1 go test -v ./tests/...

test: test-unit ## Run all tests (unit only by default)

run-dry: ## Run ingestion once (dry-run mode)
	go run cmd/ingestion/main.go --dry-run

run-markets: ## Run market ingestion only (dry-run)
	go run cmd/ingestion/main.go --dry-run --markets-only

run-news: ## Run news ingestion only (dry-run)
	go run cmd/ingestion/main.go --dry-run --news-only

run: build ## Run ingestion service (scheduled mode)
	./bin/ingestion

clean: ## Clean build artifacts
	rm -rf bin/
	go clean

docker-build: ## Build Docker image
	docker build -t leet-terminal-ingestion -f deploy/docker/Dockerfile .

# Development helpers
lint: ## Run linter
	go vet ./...
	go fmt ./...

coverage: ## Generate test coverage report
	cd services/ingestion && go test -coverprofile=coverage.out
	cd services/ingestion && go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report: services/ingestion/coverage.html"

# Database helpers
db-migrate: ## Run database migrations manually
	go run cmd/app/main.go

db-test-setup: ## Set up test database
	@echo "Creating test database..."
	psql -U leet_user -h localhost -c "CREATE DATABASE leet_terminal_test;" || true

.DEFAULT_GOAL := help

